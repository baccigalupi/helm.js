!function(factory){var root="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("undefined"!=typeof exports){var _,$,Backbone=require("backbone");try{$=require("jquery")}catch(e){}try{_=require("underscore")}catch(e){}factory(root,exports,_,$,Backbone)}else root.Backbone=factory(root,{},root._,root.jQuery||root.Zepto||root.ender||root.$,root.Backbone)}(function(root,Helm,_,$,Backbone){return Helm.Mixins={},Helm.Overrides={},Helm.RequestMiddleware={},Helm.Subscribers={},Helm.BaseClass=function(){this.initialize.apply(this,arguments)},Helm.BaseClass.prototype.initialize=function(){this._init.apply(this,arguments),this.init.apply(this,arguments)},Helm.BaseClass.prototype.init=Helm.BaseClass.prototype._init=function(){},Helm.BaseClass.extend=Backbone.Model.extend,Helm.RequestMiddleware.AuthToken=Helm.BaseClass.extend({initialize:function(args){this.args=args,this.type=args.type.toLowerCase(),this.data=_.clone(args.data||{})},perform:function(){return this.isDataRequest()?this.handlePostPutPatch():this.isDeleteRequest()&&this.handleDelete(),this.args},isDataRequest:function(){return"post"===this.type||"put"===this.type||"patch"===this.type},isDeleteRequest:function(){return"delete"===this.type},handleDelete:function(){this.args.url=this.args.url+"?authenticity_token="+encodeURIComponent(this.authenticityToken)},handlePostPutPatch:function(){_.isString(this.data)&&this.repackageStringData(),this.addAuthToken()},repackageStringData:function(){this.data=JSON.parse(this.data)},addAuthToken:function(){var data=_.extend(this.data,{authenticity_token:this.constructor.token});this.args.data=this.data=JSON.stringify(data)}}),Helm.RequestMiddleware.ServerNotifications=Helm.BaseClass.extend({initialize:function(args){this.args=args},perform:function(){return this.args.complete=this.wrapComplete(this.args.complete),this.args},wrapComplete:function(callback){return function(xhr,status){callback&&callback(xhr,status);var response=xhr.response||xhr.responseText||"{}",data=JSON.parse(response),publisher=Helm.Notifications;_.each(data.events||{},function(value,key){publisher.publish(key,value)})}}}),Backbone.ajax=function(){var args=_.map(arguments,function(a){return new Helm.RequestMiddleware.AuthToken(a).perform()});return args=_.map(args,function(a){return new Helm.RequestMiddleware.ServerNotifications(a).perform()}),Backbone.$.ajax.apply(Backbone.$,args)},Helm.Overrides.ClickEvent={isTouch:function(){return"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch},isWindows:function(){/Windows/i.test(navigator.userAgent)},shouldOverride:function(){return!this.isWindows()&&this.isTouch()},normalizeListeners:function(listeners){if(!this.shouldOverride())return listeners;var newKey,events={};return _.each(listeners,function(value,key){newKey=key.replace("click","touchstart"),events[newKey]=value}),events}},Function.prototype.bind||Function.prototype.bind||function(context){var func=this;return function(){return func.apply(context,arguments)}},Helm.Mixins.DotPath={find:function(object,path){var i,paths=path.split("."),length=paths.length,current=object;for(i=0;length>i;i++){if(!_.isObject(current)){current=void 0;break}current=current[paths[i]]}return current}},Helm.Mixins.Subviews={renderEach:function(subviews){this._subviews=subviews,_.each(subviews,function(view){view&&(view.parent=view.parent||this.defaultParent(),view.repository=view.repository||this.repository,view.templates=view.templates||this.templates,view.viewModelClasses=view.viewModelClasses||this.viewModelClasses,view.router=view.router||this.router,view.render())}.bind(this))},remove:function(){this.removeSelf(),_.each(this._subviews||[],function(view){view.remove()})},removeSelf:function(){},defaultParent:function(){return this},subviews:function(){return[]},afterRender:function(){}},Helm.Mixins.TextUtils={camelize:function(word){return word.replace(/^(\w)/,function(g){return g.toUpperCase()}).replace(/(_\w)/g,function(g){return g[1].toUpperCase()})},littelCamelize:function(word){return word.replace(/(_\w)/g,function(g){return g[1].toUpperCase()})},underscore:function(word){return word.replace(/^(\w)/,function(g){return g.toLowerCase()}).replace(/([A-Z])/g,function(g){return"_"+g.toLowerCase()})},shorten:function(text,n){return text&&n?(text.length>n&&(text=text.substr(0,n)+"..."),text):void 0},stripTags:function(text){return text.replace(/<(?:.|\n)*?>/gm," ").replace(/\s+/g," ").replace(/^\s/,"")}},Helm.Subscribers.Redirector=function(url){window.location=url},Helm.View=Backbone.View.extend(Helm.Mixins.Subviews).extend({initialize:function(opts){this._init(opts),this.init(opts)},_init:function(opts){opts||(opts={}),this.config=_.extend(_.clone(this.defaultConfig),this.config),this.parent=opts.parent||_.result(this,"parent")},defaultConfig:{attach:"append",viewModel:"ViewModel"},events:function(){return this._events?this._events:(this._events=Helm.Overrides.ClickEvent.normalizeListeners(_.result(this.config,"events")||{}),this._events)},render:function(){this.renderSelf(),this.renderSubviews(),this.attachToParent(),this.afterRender()},renderSelf:function(){var template=this.template();if(template){var rendered=template.render(this.viewModel(),_.result(this,"partials"));this.$el.html(rendered)}},renderSubviews:function(){this.renderEach(this.subviews())},attachToParent:function(){var $parent=new Helm.View.ParentFinder(this.parent,this.config.parentSelector).perform();$parent&&$parent[this.config.attach](this.el)},removeSelf:function(){Backbone.View.prototype.remove.apply(this)},viewModelClass:function(){return _.isfunction(this.config.viewModel)?this.config.viewModel():Helm.Mixins.DotPath.find(this.viewModelClasses,this.config.viewModel)||Helm.ViewModel},template:function(){return this.config.template?this.templates[_.result(this.config,"template")]:void 0},viewModel:function(){var subject=this.model||this.collection,viewModel=new(this.viewModelClass())(subject);return viewModel.repository||(viewModel.repository=this.repository),viewModel.toJSON()},init:function(){},subviews:function(){return[]},config:{},partials:function(){return this.templates}}),Helm.View.ParentFinder=Helm.BaseClass.extend({initialize:function(parent,selector){this.parent=parent,this.selector=selector},perform:function(){if(this.parent||this.selector){var found;return found=this.parent?this.selector?this.findIn$(this.searchParent()):this.searchParent():this.seekGlobally()}},searchParent:function(){return this.parent.$el?this.parent.$el:this.parent},seekGlobally:function(){var element=$(this.selector);return element.length?element:void 0},findIn$:function(parent){if(!this.selector)return parent;var element=parent.find(this.selector);return!element.length&&parent.is(this.selector)&&(element=parent),element.length?element:void 0}}),Helm.App=Helm.BaseClass.extend(Helm.Mixins.Subviews).extend({_init:function($el){this.$el=this.parent=$el,Helm.RequestMiddleware.AuthToken.token=$('meta[name="csrf-token"]').attr("content")},start:function(){this.setup(),this.render()},render:function(){this.renderEach(this.subviews()),this.afterRender()},manageHistory:function(){Helm.history?this.history=Helm.history:this.history=Helm.history=new Helm.History},routerClass:function(){if(this.constructor.Router)return this.constructor.Router;throw new Error("No Router class found!")},createRepository:function(){var Klass=this.constructor.Repository;return Klass||(Klass=this.Repository),Klass?new Klass:{}},loadTemplates:function(){this.constructor.RawTemplates&&this.loadRawTemplates()},loadRawTemplates:function(){var templates=this.constructor.Templates,rawTemplates=this.constructor.RawTemplates;_.each(rawTemplates,function(value,key){templates[key]=Hogan.compile(value)})},setup:function(){this.loadTemplates(),this.manageHistory(),this.repository||(this.repository=this.createRepository()),this.router=new(this.routerClass())(this,this.$el),this.injectRouter(),this.history.start()},injectRouter:function(){var router=this.router;router.app=this,router.repository=this.repository,router.templates=this.constructor.Templates,router.viewModelClasses=this.constructor.ViewModels,router.router=router}}),Helm.App.extend=function(){var klass=Helm.BaseClass.extend.apply(this,arguments);return klass.Models={},klass.Views={},klass.Templates={},klass.ViewModels={},klass},Helm.ViewModel=Helm.BaseClass.extend({_init:function(presented){this.presented=presented||{}},presentedToJSON:function(){var json;return this.presented&&this.presented.toJSON&&(json=this.presented.toJSON()),json||this.presented},inclusions:function(){var inclusions={};return _.each(this.include||[],function(prop){inclusions[prop]=_.result(this,prop)||_.result(this,Helm.Mixins.TextUtils.littelCamelize(prop))}.bind(this)),inclusions},toJSON:function(){var base=this.presentedToJSON(),inclusions=this.inclusions();return _.extend(base,inclusions)}}),Helm.CollectionViewModel=Helm.BaseClass.extend({_init:function(presented){this.presentedCollection=presented||[]},presentedToJSON:function(){var json;return this.presentedCollection&&this.presentedCollection.toJSON&&(json=this.presentedCollection.toJSON()),json||this.presentedCollection},inclusionsForModel:function(model){this.presented=model;var inclusions={};return _.each(this.include||[],function(prop){inclusions[prop]=_.result(this,prop)||_.result(this,Helm.Mixins.TextUtils.littelCamelize(prop))}.bind(this)),inclusions},inclusions:function(){var models=this.presentedCollection.models||this.presentedCollection;return _.map(models,function(model){return this.inclusionsForModel(model)}.bind(this))},toJSON:function(){var base=this.presentedToJSON(),inclusions=this.inclusions(),merged=_.map(base,function(baseJSON,i){return _.extend(baseJSON,inclusions[i]||{})}),json=merged;if(this.rootKey!==!1){json={};var rootKey=this.rootKey||"collection";json[rootKey]=merged}return json}}),Helm.History=Helm.BaseClass.extend({initialize:function(){this.list=[],this.init(arguments)},start:function(){this.started||(Backbone.history.start(),this.started=!0)},listenTo:function(router){router.on("route:start",this.push,this)},push:function(fragment,args){this.list.push(fragment)},pop:function(){return this.list.pop()},init:function(){}}),Helm.Notifications={publisher:_.extend({},Backbone.Events),publish:function(event,args){this.publisher.trigger(event,args)},subscribe:function(event,callback,context){this.publisher.on(event,callback,context)},unsubscribe:function(event,callback,context){this.publisher.off(event,callback,context)}},Helm.Router=Backbone.Router.extend(Helm.Mixins.Subviews).extend({initialize:function(app,$el){this.app=app,this.$el=$el,this.history=this.app.history,this.history.listenTo(this),this.init(arguments)},route:function(route,name,callback){_.isRegExp(route)||(route=this._routeToRegExp(route)),_.isfunction(name)&&(callback=name,name=""),callback||(callback=this[name]);var router=this;return Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);router.trigger("route:start",fragment,args),router.execute(callback,args),router.trigger.apply(router,["route:"+name].concat(args)),router.trigger("route",name,args),Backbone.history.trigger("route",router,name,args)}),this},go:function(fragment){this.navigate(fragment,{trigger:!0})},back:function(){this.history.pop();var fragment=this.history.pop();this.go(fragment)},render:function(subviews){this.renderEach(subviews),this.afterRender()},page:function(subviews){this.remove(),this.$el.empty(),this.render(subviews)},defaultParent:function(){return this.$el},init:function(){}}),Helm});
//# sourceMappingURL=helm-0.7.0.min.js.map
